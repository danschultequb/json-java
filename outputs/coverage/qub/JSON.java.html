<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JSON.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">qub</a> &gt; <span class="el_source">JSON.java</span></div><h1>JSON.java</h1><pre class="source lang-java linenums">package qub;

/**
 * A collection of functions for interacting with JSON content.
 */
public interface JSON
{
    /**
     * The default indentation String when formatting a JSON document.
     */
    String defaultSingleIndent = &quot;  &quot;;

    /**
     * Parse a JSONSegment from the provided text.
     * @param text The text to parse into a JSONSegment.
     * @return The parsed JSONSegment.
     */
    static Result&lt;JSONSegment&gt; parse(String text)
    {
<span class="fc" id="L20">        PreCondition.assertNotNullAndNotEmpty(text, &quot;text&quot;);</span>

<span class="fc" id="L22">        return JSON.parse(Strings.iterable(text));</span>
    }

    /**
     * Parse a JSONSegment from the provided characters.
     * @param characters The characters to parse into a JSONSegment.
     * @return The parsed JSONSegment.
     */
    static Result&lt;JSONSegment&gt; parse(Iterable&lt;Character&gt; characters)
    {
<span class="fc" id="L32">        PreCondition.assertNotNullAndNotEmpty(characters, &quot;characters&quot;);</span>

<span class="fc" id="L34">        return JSON.parse(characters.iterate());</span>
    }

    /**
     * Parse a JSONSegment from the provided characters.
     * @param characters The characters to parse into a JSONSegment.
     * @return The parsed JSONSegment.
     */
    static Result&lt;JSONSegment&gt; parse(Iterator&lt;Character&gt; characters)
    {
<span class="fc" id="L44">        PreCondition.assertNotNull(characters, &quot;characters&quot;);</span>

<span class="fc" id="L46">        return JSON.parse(JSON.createTokenizer(characters));</span>
    }

    /**
     * Parse a JSONSegment from the provided JSONTokenizer.
     * @param tokenizer The tokenizer that produces JSONTokens.
     * @return The parsed JSONSegment.
     */
    static Result&lt;JSONSegment&gt; parse(JSONTokenizer tokenizer)
    {
<span class="fc" id="L56">        PreCondition.assertNotNull(tokenizer, &quot;tokenizer&quot;);</span>

<span class="fc" id="L58">        return Result.create(() -&gt;</span>
        {
<span class="fc" id="L60">            JSON.ensureHasStarted(tokenizer);</span>

<span class="fc bfc" id="L62" title="All 2 branches covered.">            if (!tokenizer.hasCurrent())</span>
            {
<span class="fc" id="L64">                throw new ParseException(&quot;No JSON tokens found.&quot;);</span>
            }

            JSONSegment result;
<span class="fc bfc" id="L68" title="All 7 branches covered.">            switch (tokenizer.getCurrent().getType())</span>
            {
                case LeftCurlyBracket:
<span class="fc" id="L71">                    result = JSON.parseObject(tokenizer).await();</span>
<span class="fc" id="L72">                    break;</span>

                case LeftSquareBracket:
<span class="fc" id="L75">                    result = JSON.parseArray(tokenizer).await();</span>
<span class="fc" id="L76">                    break;</span>

                case Boolean:
<span class="fc bfc" id="L79" title="All 2 branches covered.">                    result = JSONBoolean.get(JSONToken.falseToken != JSON.takeCurrent(tokenizer));</span>
<span class="fc" id="L80">                    break;</span>

                case Null:
<span class="fc" id="L83">                    result = JSONNull.segment;</span>
<span class="fc" id="L84">                    JSON.next(tokenizer);</span>
<span class="fc" id="L85">                    break;</span>

                case Number:
<span class="fc" id="L88">                    result = JSONNumber.get(JSON.takeCurrent(tokenizer).getText());</span>
<span class="fc" id="L89">                    break;</span>

                case QuotedString:
<span class="fc" id="L92">                    result = JSONString.getFromQuoted(JSON.takeCurrent(tokenizer).getText());</span>
<span class="fc" id="L93">                    break;</span>

                default:
<span class="fc" id="L96">                    throw new ParseException(&quot;Unexpected JSON token: &quot; + tokenizer.getCurrent());</span>
            }

<span class="fc" id="L99">            PostCondition.assertNotNull(result, &quot;result&quot;);</span>

<span class="fc" id="L101">            return result;</span>
        });
    }

    /**
     * Parse a JSONObject from the provided text.
     * @param text The text to parse into a JSONObject.
     * @return The parsed JSONObject.
     */
    static Result&lt;JSONObject&gt; parseObject(String text)
    {
<span class="fc" id="L112">        PreCondition.assertNotNullAndNotEmpty(text, &quot;text&quot;);</span>

<span class="fc" id="L114">        return JSON.parseObject(Strings.iterable(text));</span>
    }

    /**
     * Parse a JSONObject from the provided characters.
     * @param characters The characters to parse into a JSONObject.
     * @return The parsed JSONObject.
     */
    static Result&lt;JSONObject&gt; parseObject(Iterable&lt;Character&gt; characters)
    {
<span class="fc" id="L124">        PreCondition.assertNotNullAndNotEmpty(characters, &quot;characters&quot;);</span>

<span class="fc" id="L126">        return JSON.parseObject(characters.iterate());</span>
    }

    /**
     * Parse a JSONObject from the provided characters.
     * @param characters The characters to parse into a JSONObject.
     * @return The parsed JSONObject.
     */
    static Result&lt;JSONObject&gt; parseObject(Iterator&lt;Character&gt; characters)
    {
<span class="fc" id="L136">        PreCondition.assertNotNull(characters, &quot;characters&quot;);</span>

<span class="fc" id="L138">        return JSON.parseObject(JSON.createTokenizer(characters));</span>
    }

    /**
     * Parse a JSONObject from the provided JSONTokenizer.
     * @param tokenizer The tokenizer that produces JSONTokens.
     * @return The parsed JSONObject.
     */
    static Result&lt;JSONObject&gt; parseObject(JSONTokenizer tokenizer)
    {
<span class="fc" id="L148">        PreCondition.assertNotNull(tokenizer, &quot;tokenizer&quot;);</span>
<span class="fc" id="L149">        PreCondition.assertTrue(tokenizer.hasCurrent(), &quot;tokenizer.hasCurrent()&quot;);</span>
<span class="fc" id="L150">        PreCondition.assertEqual(JSONToken.leftCurlyBracket, tokenizer.getCurrent(), &quot;tokenizer.getCurrent()&quot;);</span>

<span class="fc" id="L152">        return Result.create(() -&gt;</span>
        {
<span class="fc" id="L154">            final JSONToken leftCurlyBracket = JSON.takeCurrent(tokenizer);</span>

<span class="fc" id="L156">            final List&lt;JSONObjectProperty&gt; properties = List.create();</span>
<span class="fc" id="L157">            JSONToken rightCurlyBracket = null;</span>
<span class="fc" id="L158">            boolean expectProperty = true;</span>
<span class="fc bfc" id="L159" title="All 4 branches covered.">            while (tokenizer.hasCurrent() &amp;&amp; rightCurlyBracket == null)</span>
            {
<span class="fc bfc" id="L161" title="All 4 branches covered.">                switch (tokenizer.getCurrent().getType())</span>
                {
                    case QuotedString:
<span class="fc bfc" id="L164" title="All 2 branches covered.">                        if (!expectProperty)</span>
                        {
<span class="fc" id="L166">                            throw new ParseException(&quot;Expected object property separator (',') or right curly bracket ('}').&quot;);</span>
                        }
<span class="fc" id="L168">                        properties.add(JSON.parseObjectProperty(tokenizer).await());</span>
<span class="fc" id="L169">                        expectProperty = false;</span>
<span class="fc" id="L170">                        break;</span>

                    case Comma:
<span class="fc bfc" id="L173" title="All 2 branches covered.">                        if (expectProperty)</span>
                        {
<span class="fc bfc" id="L175" title="All 2 branches covered.">                            if (properties.any())</span>
                            {
<span class="fc" id="L177">                                throw new ParseException(&quot;Expected quoted-string object property name.&quot;);</span>
                            }
                            else
                            {
<span class="fc" id="L181">                                throw new ParseException(&quot;Expected quoted-string object property name or right curly bracket ('}').&quot;);</span>
                            }
                        }
<span class="fc" id="L184">                        JSON.next(tokenizer);</span>
<span class="fc" id="L185">                        expectProperty = true;</span>
<span class="fc" id="L186">                        break;</span>

                    case RightCurlyBracket:
<span class="fc bfc" id="L189" title="All 4 branches covered.">                        if (properties.any() &amp;&amp; expectProperty)</span>
                        {
<span class="fc" id="L191">                            throw new ParseException(&quot;Expected quoted-string object property name.&quot;);</span>
                        }
<span class="fc" id="L193">                        rightCurlyBracket = JSON.takeCurrent(tokenizer);</span>
<span class="fc" id="L194">                        break;</span>

                    default:
<span class="fc bfc" id="L197" title="All 2 branches covered.">                        if (properties.any())</span>
                        {
<span class="fc bfc" id="L199" title="All 2 branches covered.">                            if (expectProperty)</span>
                            {
<span class="fc" id="L201">                                throw new ParseException(&quot;Expected quoted-string object property name.&quot;);</span>
                            }
                            else
                            {
<span class="fc" id="L205">                                throw new ParseException(&quot;Expected object property separator (',') or right curly bracket ('}').&quot;);</span>
                            }
                        }
                        else
                        {
<span class="fc" id="L210">                            throw new ParseException(&quot;Expected quoted-string object property name or right curly bracket ('}').&quot;);</span>
                        }
                }
            }

<span class="fc bfc" id="L215" title="All 4 branches covered.">            if (properties.any() &amp;&amp; expectProperty)</span>
            {
<span class="fc" id="L217">                throw new ParseException(&quot;Missing object property.&quot;);</span>
            }
<span class="fc bfc" id="L219" title="All 2 branches covered.">            else if (rightCurlyBracket == null)</span>
            {
<span class="fc" id="L221">                throw new ParseException(&quot;Missing object right curly bracket ('}').&quot;);</span>
            }

<span class="fc" id="L224">            return JSONObject.create(properties);</span>
        });
    }

    /**
     * Parse a JSONObjectProperty from the provided text.
     * @param text The text to parse into a JSONObjectProperty.
     * @return The parsed JSONObjectProperty.
     */
    static Result&lt;JSONObjectProperty&gt; parseObjectProperty(String text)
    {
<span class="fc" id="L235">        PreCondition.assertNotNullAndNotEmpty(text, &quot;text&quot;);</span>

<span class="fc" id="L237">        return JSON.parseObjectProperty(Strings.iterable(text));</span>
    }

    /**
     * Parse a JSONObjectProperty from the provided characters.
     * @param characters The characters to parse into a JSONObjectProperty.
     * @return The parsed JSONObjectProperty.
     */
    static Result&lt;JSONObjectProperty&gt; parseObjectProperty(Iterable&lt;Character&gt; characters)
    {
<span class="fc" id="L247">        PreCondition.assertNotNullAndNotEmpty(characters, &quot;characters&quot;);</span>

<span class="fc" id="L249">        return JSON.parseObjectProperty(characters.iterate());</span>
    }

    /**
     * Parse a JSONObjectProperty from the provided characters.
     * @param characters The characters to parse into a JSONObjectProperty.
     * @return The parsed JSONObjectProperty.
     */
    static Result&lt;JSONObjectProperty&gt; parseObjectProperty(Iterator&lt;Character&gt; characters)
    {
<span class="fc" id="L259">        PreCondition.assertNotNull(characters, &quot;characters&quot;);</span>

<span class="fc" id="L261">        return JSON.parseObjectProperty(JSON.createTokenizer(characters));</span>
    }

    /**
     * Parse a JSONObjectProperty from the provided JSONTokenizer.
     * @param tokenizer The tokenizer that produces JSONTokens.
     * @return The parsed JSONObjectProperty.
     */
    static Result&lt;JSONObjectProperty&gt; parseObjectProperty(JSONTokenizer tokenizer)
    {
<span class="fc" id="L271">        PreCondition.assertNotNull(tokenizer, &quot;tokenizer&quot;);</span>
<span class="fc" id="L272">        PreCondition.assertTrue(tokenizer.hasCurrent(), &quot;tokenizer.hasCurrent()&quot;);</span>
<span class="fc" id="L273">        PreCondition.assertEqual(JSONTokenType.QuotedString, tokenizer.getCurrent().getType(), &quot;tokenizer.getCurrent().getType()&quot;);</span>

<span class="fc" id="L275">        return Result.create(() -&gt;</span>
        {
<span class="fc" id="L277">            final String quotedPropertyName = JSON.takeCurrent(tokenizer).getText();</span>
<span class="fc" id="L278">            final String propertyName = quotedPropertyName.substring(1, quotedPropertyName.length() - 1);</span>

<span class="fc bfc" id="L280" title="All 2 branches covered.">            if (!tokenizer.hasCurrent())</span>
            {
<span class="fc" id="L282">                throw new ParseException(&quot;Missing object property name and value separator (':').&quot;);</span>
            }
<span class="fc bfc" id="L284" title="All 2 branches covered.">            else if (tokenizer.getCurrent().getType() != JSONTokenType.Colon)</span>
            {
<span class="fc" id="L286">                throw new ParseException(&quot;Expected object property name and value separator (':').&quot;);</span>
            }

            JSONSegment propertyValue;
<span class="fc bfc" id="L290" title="All 2 branches covered.">            if (!JSON.next(tokenizer))</span>
            {
<span class="fc" id="L292">                throw new ParseException(&quot;Missing object property value.&quot;);</span>
            }
            else
            {
<span class="fc bfc" id="L296" title="All 3 branches covered.">                switch (tokenizer.getCurrent().getType())</span>
                {
                    case Comma:
<span class="fc" id="L299">                        throw new ParseException(&quot;Expected object property value.&quot;);</span>

                    case Boolean:
                    case Null:
                    case Number:
                    case QuotedString:
                    case LeftCurlyBracket:
                    case LeftSquareBracket:
<span class="fc" id="L307">                        propertyValue = JSON.parse(tokenizer).await();</span>
<span class="fc" id="L308">                        break;</span>

                    default:
<span class="fc" id="L311">                        throw new ParseException(&quot;Unexpected object property value token: &quot; + Strings.escapeAndQuote(tokenizer.getCurrent()));</span>
                }
            }

<span class="fc" id="L315">            return JSONObjectProperty.create(propertyName, propertyValue);</span>
        });
    }

    /**
     * Parse a JSONArray from the provided text.
     * @param text The text to parse into a JSONArray.
     * @return The parsed JSONArray.
     */
    static Result&lt;JSONArray&gt; parseArray(String text)
    {
<span class="fc" id="L326">        PreCondition.assertNotNullAndNotEmpty(text, &quot;text&quot;);</span>

<span class="fc" id="L328">        return JSON.parseArray(Strings.iterable(text));</span>
    }

    /**
     * Parse a JSONArray from the provided characters.
     * @param characters The characters to parse into a JSONArray.
     * @return The parsed JSONArray.
     */
    static Result&lt;JSONArray&gt; parseArray(Iterable&lt;Character&gt; characters)
    {
<span class="fc" id="L338">        PreCondition.assertNotNullAndNotEmpty(characters, &quot;characters&quot;);</span>

<span class="fc" id="L340">        return JSON.parseArray(characters.iterate());</span>
    }

    /**
     * Parse a JSONArray from the provided characters.
     * @param characters The characters to parse into a JSONArray.
     * @return The parsed JSONArray.
     */
    static Result&lt;JSONArray&gt; parseArray(Iterator&lt;Character&gt; characters)
    {
<span class="fc" id="L350">        PreCondition.assertNotNull(characters, &quot;characters&quot;);</span>

<span class="fc" id="L352">        return JSON.parseArray(JSON.createTokenizer(characters));</span>
    }

    /**
     * Parse a JSONArray from the provided JSONTokenizer.
     * @param tokenizer The tokenizer that produces JSONTokens.
     * @return The parsed JSONArray.
     */
    static Result&lt;JSONArray&gt; parseArray(JSONTokenizer tokenizer)
    {
<span class="fc" id="L362">        PreCondition.assertNotNull(tokenizer, &quot;tokenizer&quot;);</span>
<span class="fc" id="L363">        PreCondition.assertTrue(tokenizer.hasCurrent(), &quot;tokenizer.hasCurrent()&quot;);</span>
<span class="fc" id="L364">        PreCondition.assertEqual(JSONToken.leftSquareBracket, tokenizer.getCurrent(), &quot;tokenizer.getCurrent()&quot;);</span>

<span class="fc" id="L366">        return Result.create(() -&gt;</span>
        {
<span class="fc" id="L368">            final JSONToken leftSquareBracket = JSON.takeCurrent(tokenizer);</span>

<span class="fc" id="L370">            final List&lt;JSONSegment&gt; elements = List.create();</span>

<span class="fc" id="L372">            JSONToken rightSquareBracket = null;</span>
<span class="fc" id="L373">            boolean expectElement = true;</span>
<span class="fc bfc" id="L374" title="All 4 branches covered.">            while (tokenizer.hasCurrent() &amp;&amp; rightSquareBracket == null)</span>
            {
<span class="fc bfc" id="L376" title="All 4 branches covered.">                switch (tokenizer.getCurrent().getType())</span>
                {
                    case Boolean:
                    case Null:
                    case Number:
                    case QuotedString:
                    case LeftCurlyBracket:
                    case LeftSquareBracket:
<span class="fc bfc" id="L384" title="All 2 branches covered.">                        if (!expectElement)</span>
                        {
<span class="fc" id="L386">                            throw new ParseException(&quot;Expected array element separator (',') or right square bracket (']').&quot;);</span>
                        }
<span class="fc" id="L388">                        elements.add(JSON.parse(tokenizer).await());</span>
<span class="fc" id="L389">                        expectElement = false;</span>
<span class="fc" id="L390">                        break;</span>

                    case Comma:
<span class="fc bfc" id="L393" title="All 2 branches covered.">                        if (expectElement)</span>
                        {
<span class="fc" id="L395">                            throw new ParseException(&quot;Expected array element.&quot;);</span>
                        }
<span class="fc" id="L397">                        JSON.next(tokenizer);</span>
<span class="fc" id="L398">                        expectElement = true;</span>
<span class="fc" id="L399">                        break;</span>

                    case RightSquareBracket:
<span class="fc bfc" id="L402" title="All 4 branches covered.">                        if (elements.any() &amp;&amp; expectElement)</span>
                        {
<span class="fc" id="L404">                            throw new ParseException(&quot;Expected array element.&quot;);</span>
                        }
<span class="fc" id="L406">                        rightSquareBracket = JSON.takeCurrent(tokenizer);</span>
<span class="fc" id="L407">                        expectElement = false;</span>
<span class="fc" id="L408">                        break;</span>

                    default:
<span class="fc" id="L411">                        throw new ParseException(&quot;Unexpected array element token: &quot; + Strings.escapeAndQuote(tokenizer.getCurrent()));</span>
                }
            }

<span class="fc bfc" id="L415" title="All 4 branches covered.">            if (elements.any() &amp;&amp; expectElement)</span>
            {
<span class="fc" id="L417">                throw new ParseException(&quot;Missing array element.&quot;);</span>
            }
<span class="fc bfc" id="L419" title="All 2 branches covered.">            else if (rightSquareBracket == null)</span>
            {
<span class="fc" id="L421">                throw new ParseException(&quot;Missing array right square bracket (']').&quot;);</span>
            }

<span class="fc" id="L424">            return JSONArray.create(elements);</span>
        });
    }

    static JSONTokenizer createTokenizer(Iterator&lt;Character&gt; characters)
    {
<span class="fc" id="L430">        PreCondition.assertNotNull(characters, &quot;characters&quot;);</span>

<span class="fc" id="L432">        final JSONTokenizer result = JSONTokenizer.create(characters);</span>
<span class="fc" id="L433">        JSON.next(result);</span>

<span class="fc" id="L435">        PostCondition.assertNotNull(result, &quot;result&quot;);</span>
<span class="fc" id="L436">        PostCondition.assertTrue(result.hasStarted(), &quot;result.hasStarted()&quot;);</span>

<span class="fc" id="L438">        return result;</span>
    }

    static boolean shouldSkipCurrentToken(JSONTokenizer tokenizer)
    {
<span class="fc" id="L443">        PreCondition.assertNotNull(tokenizer, &quot;tokenizer&quot;);</span>
<span class="fc" id="L444">        PreCondition.assertTrue(tokenizer.hasCurrent(), &quot;tokenizer.hasCurrent()&quot;);</span>

        boolean result;
<span class="fc bfc" id="L447" title="All 2 branches covered.">        switch (tokenizer.getCurrent().getType())</span>
        {
            case BlockComment:
            case LineComment:
            case NewLine:
            case Whitespace:
<span class="fc" id="L453">                result = true;</span>
<span class="fc" id="L454">                break;</span>

            default:
<span class="fc" id="L457">                result = false;</span>
                break;
        }

<span class="fc" id="L461">        return result;</span>
    }

    static boolean next(JSONTokenizer tokenizer)
    {
<span class="fc" id="L466">        PreCondition.assertNotNull(tokenizer, &quot;tokenizer&quot;);</span>

<span class="fc" id="L468">        boolean result = tokenizer.next();</span>
<span class="fc bfc" id="L469" title="All 4 branches covered.">        while (result &amp;&amp; JSON.shouldSkipCurrentToken(tokenizer))</span>
        {
<span class="fc" id="L471">            result = tokenizer.next();</span>
        }

<span class="fc" id="L474">        return result;</span>
    }

    static void ensureHasStarted(JSONTokenizer tokenizer)
    {
<span class="fc" id="L479">        PreCondition.assertNotNull(tokenizer, &quot;tokenizer&quot;);</span>

<span class="fc bfc" id="L481" title="All 6 branches covered.">        if (!tokenizer.hasStarted() || (tokenizer.hasCurrent() &amp;&amp; JSON.shouldSkipCurrentToken(tokenizer)))</span>
        {
<span class="fc" id="L483">            JSON.next(tokenizer);</span>
        }

<span class="fc" id="L486">        PostCondition.assertTrue(tokenizer.hasStarted(), &quot;tokenizer.hasStarted()&quot;);</span>
<span class="fc" id="L487">    }</span>

    static JSONToken takeCurrent(JSONTokenizer tokenizer)
    {
<span class="fc" id="L491">        PreCondition.assertNotNull(tokenizer, &quot;tokenizer&quot;);</span>
<span class="fc" id="L492">        PreCondition.assertTrue(tokenizer.hasCurrent(), &quot;tokenizer.hasCurrent()&quot;);</span>

<span class="fc" id="L494">        final JSONToken result = tokenizer.getCurrent();</span>
<span class="fc" id="L495">        JSON.next(tokenizer);</span>

<span class="fc" id="L497">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>