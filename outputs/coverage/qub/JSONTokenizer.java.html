<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JSONTokenizer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">qub</a> &gt; <span class="el_source">JSONTokenizer.java</span></div><h1>JSONTokenizer.java</h1><pre class="source lang-java linenums">package qub;

public class JSONTokenizer implements Iterator&lt;JSONToken&gt;
{
    private final Lexer lexer;
    private final int firstTokenStartIndex;
    private final Action1&lt;Issue&gt; onIssue;
    private boolean hasStarted;
    private JSONToken current;

    public JSONTokenizer(String text)
    {
<span class="fc" id="L13">        this(text, 0);</span>
<span class="fc" id="L14">    }</span>

    public JSONTokenizer(String text, int firstTokenStartIndex)
    {
<span class="fc" id="L18">        this(text, firstTokenStartIndex, (Action1&lt;Issue&gt;)null);</span>
<span class="fc" id="L19">    }</span>

    public JSONTokenizer(String text, List&lt;Issue&gt; issues)
    {
<span class="fc" id="L23">        this(text, 0, issues);</span>
<span class="fc" id="L24">    }</span>

    public JSONTokenizer(String text, int firstTokenStartIndex, final List&lt;Issue&gt; issues)
    {
<span class="fc" id="L28">        this(text, firstTokenStartIndex, getAddToListAction(issues));</span>
<span class="fc" id="L29">    }</span>

    public JSONTokenizer(String text, int firstTokenStartIndex, Action1&lt;Issue&gt; onIssue)
    {
<span class="fc" id="L33">        this(new StringIterator(text), firstTokenStartIndex, onIssue);</span>
<span class="fc" id="L34">    }</span>

    public JSONTokenizer(Iterator&lt;Character&gt; characters, List&lt;Issue&gt; issues)
    {
<span class="fc" id="L38">        this(characters, 0, getAddToListAction(issues));</span>
<span class="fc" id="L39">    }</span>

    public JSONTokenizer(Iterator&lt;Character&gt; characters, int firstTokenStartIndex, Action1&lt;Issue&gt; onIssue)
    {
<span class="fc" id="L43">        this(new Lexer(characters), firstTokenStartIndex, onIssue);</span>
<span class="fc" id="L44">    }</span>

    public JSONTokenizer(Lexer lexer, int firstTokenStartIndex, Action1&lt;Issue&gt; onIssue)
<span class="fc" id="L47">    {</span>
<span class="fc" id="L48">        this.lexer = lexer;</span>
<span class="fc" id="L49">        this.firstTokenStartIndex = firstTokenStartIndex;</span>
<span class="fc" id="L50">        this.onIssue = onIssue;</span>
<span class="fc" id="L51">    }</span>

    private void addIssue(Issue issue)
    {
<span class="fc bfc" id="L55" title="All 2 branches covered.">        if (onIssue != null)</span>
        {
<span class="fc" id="L57">            onIssue.run(issue);</span>
        }
<span class="fc" id="L59">    }</span>

    @Override
    public boolean hasStarted()
    {
<span class="fc" id="L64">        return hasStarted;</span>
    }

    @Override
    public boolean hasCurrent()
    {
<span class="fc bfc" id="L70" title="All 2 branches covered.">        return current != null;</span>
    }

    @Override
    public JSONToken getCurrent()
    {
<span class="fc" id="L76">        return current;</span>
    }

    @Override
    public boolean next()
    {
<span class="fc bfc" id="L82" title="All 2 branches covered.">        if (!hasStarted)</span>
        {
<span class="fc" id="L84">            hasStarted = true;</span>

<span class="pc bpc" id="L86" title="1 of 2 branches missed.">            if (!lexer.hasStarted())</span>
            {
<span class="fc" id="L88">                lexer.next();</span>
            }
        }

<span class="fc bfc" id="L92" title="All 2 branches covered.">        if (lexer.hasCurrent())</span>
        {
<span class="fc bfc" id="L94" title="All 2 branches covered.">            int tokenStartIndex = hasCurrent() ? getCurrent().getAfterEndIndex() : firstTokenStartIndex;</span>
<span class="fc bfc" id="L95" title="All 13 branches covered.">            switch (lexer.getCurrent().getType())</span>
            {
                case LeftCurlyBracket:
<span class="fc" id="L98">                    current = JSONToken.leftCurlyBracket(tokenStartIndex);</span>
<span class="fc" id="L99">                    lexer.next();</span>
<span class="fc" id="L100">                    break;</span>

                case RightCurlyBracket:
<span class="fc" id="L103">                    current = JSONToken.rightCurlyBracket(tokenStartIndex);</span>
<span class="fc" id="L104">                    lexer.next();</span>
<span class="fc" id="L105">                    break;</span>

                case LeftSquareBracket:
<span class="fc" id="L108">                    current = JSONToken.leftSquareBracket(tokenStartIndex);</span>
<span class="fc" id="L109">                    lexer.next();</span>
<span class="fc" id="L110">                    break;</span>

                case RightSquareBracket:
<span class="fc" id="L113">                    current = JSONToken.rightSquareBracket(tokenStartIndex);</span>
<span class="fc" id="L114">                    lexer.next();</span>
<span class="fc" id="L115">                    break;</span>

                case Colon:
<span class="fc" id="L118">                    current = JSONToken.colon(tokenStartIndex);</span>
<span class="fc" id="L119">                    lexer.next();</span>
<span class="fc" id="L120">                    break;</span>

                case Comma:
<span class="fc" id="L123">                    current = JSONToken.comma(tokenStartIndex);</span>
<span class="fc" id="L124">                    lexer.next();</span>
<span class="fc" id="L125">                    break;</span>

                case Letters:
<span class="fc bfc" id="L128" title="All 4 branches covered.">                    switch (lexer.getCurrent().toString().toLowerCase())</span>
                    {
                        case &quot;true&quot;:
<span class="fc bfc" id="L131" title="All 2 branches covered.">                            if (!lexer.getCurrent().toString().equals(&quot;true&quot;))</span>
                            {
<span class="fc" id="L133">                                addIssue(JSONIssues.shouldBeLowercased(tokenStartIndex, 4));</span>
                            }
<span class="fc" id="L135">                            current = JSONToken.booleanToken(lexer.getCurrent().toString(), tokenStartIndex);</span>
<span class="fc" id="L136">                            break;</span>

                        case &quot;false&quot;:
<span class="fc bfc" id="L139" title="All 2 branches covered.">                            if (!lexer.getCurrent().toString().equals(&quot;false&quot;))</span>
                            {
<span class="fc" id="L141">                                addIssue(JSONIssues.shouldBeLowercased(tokenStartIndex, 5));</span>
                            }
<span class="fc" id="L143">                            current = JSONToken.booleanToken(lexer.getCurrent().toString(), tokenStartIndex);</span>
<span class="fc" id="L144">                            break;</span>

                        case &quot;null&quot;:
<span class="fc bfc" id="L147" title="All 2 branches covered.">                            if (!lexer.getCurrent().toString().equals(&quot;null&quot;))</span>
                            {
<span class="fc" id="L149">                                addIssue(JSONIssues.shouldBeLowercased(tokenStartIndex, 4));</span>
                            }
<span class="fc" id="L151">                            current = JSONToken.nullToken(lexer.getCurrent().toString(), tokenStartIndex);</span>
<span class="fc" id="L152">                            break;</span>

                        default:
<span class="fc" id="L155">                            current = JSONToken.unrecognized(lexer.getCurrent().toString(), tokenStartIndex);</span>
                            break;
                    }
<span class="fc" id="L158">                    lexer.next();</span>
<span class="fc" id="L159">                    break;</span>

                case SingleQuote:
                case DoubleQuote:
<span class="fc" id="L163">                    final Lex startQuote = lexer.takeCurrent();</span>
<span class="fc" id="L164">                    final StringBuilder quotedStringText = new StringBuilder(startQuote.toString());</span>

<span class="fc" id="L166">                    boolean foundEndQuote = false;</span>
<span class="fc" id="L167">                    boolean escaped = false;</span>

<span class="fc bfc" id="L169" title="All 4 branches covered.">                    while (!foundEndQuote &amp;&amp; lexer.hasCurrent())</span>
                    {
<span class="fc" id="L171">                        quotedStringText.append(lexer.getCurrent().toString());</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">                        if (escaped)</span>
                        {
<span class="fc" id="L174">                            escaped = false;</span>
                        }
<span class="fc bfc" id="L176" title="All 2 branches covered.">                        else if (lexer.getCurrent().getType() == LexType.Backslash)</span>
                        {
<span class="fc" id="L178">                            escaped = true;</span>
                        }
<span class="fc bfc" id="L180" title="All 2 branches covered.">                        else if (lexer.getCurrent().getType() == startQuote.getType())</span>
                        {
<span class="fc" id="L182">                            foundEndQuote = true;</span>
                        }
<span class="fc" id="L184">                        lexer.next();</span>
                    }

<span class="fc bfc" id="L187" title="All 2 branches covered.">                    if (!foundEndQuote) {</span>
<span class="fc" id="L188">                        addIssue(JSONIssues.missingEndQuote(startQuote.toString(), tokenStartIndex, quotedStringText.length()));</span>
                    }

<span class="fc" id="L191">                    current = JSONToken.quotedString(quotedStringText.toString(), tokenStartIndex, foundEndQuote);</span>
<span class="fc" id="L192">                    break;</span>

                case Space:
                case Tab:
                case CarriageReturn:
<span class="fc" id="L197">                    final StringBuilder whitespaceText = new StringBuilder(lexer.takeCurrent().toString());</span>
<span class="fc bfc" id="L198" title="All 4 branches covered.">                    while (lexer.hasCurrent() &amp;&amp; lexer.getCurrent().isWhitespace())</span>
                    {
<span class="fc" id="L200">                        whitespaceText.append(lexer.takeCurrent().toString());</span>
                    }
<span class="fc" id="L202">                    current = JSONToken.whitespace(whitespaceText.toString(), tokenStartIndex);</span>
<span class="fc" id="L203">                    break;</span>

                case NewLine:
                case CarriageReturnNewLine:
<span class="fc" id="L207">                    current = JSONToken.newLine(lexer.takeCurrent().toString(), tokenStartIndex);</span>
<span class="fc" id="L208">                    break;</span>

                case Dash:
                case Digits:
                case Period:
<span class="fc" id="L213">                    final StringBuilder numberText = new StringBuilder();</span>

<span class="fc bfc" id="L215" title="All 2 branches covered.">                    if (lexer.getCurrent().getType() == LexType.Dash)</span>
                    {
                        // Negative sign
<span class="fc" id="L218">                        numberText.append(lexer.takeCurrent().toString());</span>
                    }

<span class="fc bfc" id="L221" title="All 2 branches covered.">                    if (!lexer.hasCurrent())</span>
                    {
<span class="fc" id="L223">                        addIssue(JSONIssues.missingWholeNumberDigits(tokenStartIndex, numberText.length()));</span>
                    }
<span class="fc bfc" id="L225" title="All 2 branches covered.">                    else if (lexer.getCurrent().getType() != LexType.Digits)</span>
                    {
<span class="fc" id="L227">                        addIssue(JSONIssues.expectedWholeNumberDigits(tokenStartIndex + numberText.length(), lexer.getCurrent().getLength()));</span>
                    }
                    else
                    {
<span class="fc" id="L231">                        numberText.append(lexer.takeCurrent().toString());</span>
                    }

<span class="fc bfc" id="L234" title="All 4 branches covered.">                    if (lexer.hasCurrent() &amp;&amp; lexer.getCurrent().getType() == LexType.Period)</span>
                    {
                        // Decimal point
<span class="fc" id="L237">                        final int decimalPointStartIndex = tokenStartIndex + numberText.length();</span>
<span class="fc" id="L238">                        numberText.append(lexer.takeCurrent().toString());</span>

<span class="fc bfc" id="L240" title="All 2 branches covered.">                        if (!lexer.hasCurrent())</span>
                        {
<span class="fc" id="L242">                            addIssue(JSONIssues.missingFractionalNumberDigits(decimalPointStartIndex, 1));</span>
                        }
<span class="fc bfc" id="L244" title="All 2 branches covered.">                        else if (lexer.getCurrent().getType() != LexType.Digits)</span>
                        {
<span class="fc" id="L246">                            addIssue(JSONIssues.expectedFractionalNumberDigits(lexer.getCurrent().getStartIndex(), lexer.getCurrent().getLength()));</span>
                        }
                        else
                        {
                            // Fractional number digits
<span class="fc" id="L251">                            numberText.append(lexer.takeCurrent().toString());</span>
                        }
                    }

<span class="fc bfc" id="L255" title="All 4 branches covered.">                    if (lexer.hasCurrent() &amp;&amp; lexer.getCurrent().toString().equalsIgnoreCase(&quot;e&quot;))</span>
                    {
                        // e
<span class="fc" id="L258">                        final int eStartIndex = tokenStartIndex + numberText.length();</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">                        if (lexer.getCurrent().toString().equals(&quot;E&quot;))</span>
                        {
<span class="fc" id="L261">                            addIssue(JSONIssues.shouldBeLowercased(eStartIndex, 1));</span>
                        }
<span class="fc" id="L263">                        numberText.append(lexer.takeCurrent().toString());</span>

<span class="fc bfc" id="L265" title="All 2 branches covered.">                        if (!lexer.hasCurrent())</span>
                        {
<span class="fc" id="L267">                            addIssue(JSONIssues.missingExponentNumberDigits(eStartIndex, 1));</span>
                        }
                        else
                        {
<span class="fc" id="L271">                            final int exponentSignOrDigitsStartIndex = tokenStartIndex + numberText.length();</span>
<span class="fc bfc" id="L272" title="All 4 branches covered.">                            if (lexer.getCurrent().getType() == LexType.Dash || lexer.getCurrent().getType() == LexType.Plus)</span>
                            {
                                // Exponent number sign
<span class="fc" id="L275">                                numberText.append(lexer.takeCurrent().toString());</span>
                            }

<span class="fc bfc" id="L278" title="All 2 branches covered.">                            if (!lexer.hasCurrent())</span>
                            {
<span class="fc" id="L280">                                addIssue(JSONIssues.missingExponentNumberDigits(exponentSignOrDigitsStartIndex, 1));</span>
                            }
<span class="fc bfc" id="L282" title="All 2 branches covered.">                            else if (lexer.getCurrent().getType() != LexType.Digits)</span>
                            {
<span class="fc" id="L284">                                addIssue(JSONIssues.expectedExponentNumberDigits(tokenStartIndex + numberText.length(), lexer.getCurrent().getLength()));</span>
                            }
                            else
                            {
                                // Exponent number digits
<span class="fc" id="L289">                                numberText.append(lexer.takeCurrent().toString());</span>
                            }
                        }
                    }

<span class="fc" id="L294">                    current = JSONToken.number(numberText.toString(), tokenStartIndex);</span>
<span class="fc" id="L295">                    break;</span>

                case ForwardSlash:
<span class="fc" id="L298">                    final StringBuilder commentText = new StringBuilder(lexer.takeCurrent().toString());</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">                    if (!lexer.hasCurrent())</span>
                    {
<span class="fc" id="L301">                        addIssue(JSONIssues.missingCommentSlashOrAsterisk(tokenStartIndex, 1));</span>
<span class="fc" id="L302">                        current = JSONToken.unrecognized(commentText.toString(), tokenStartIndex);</span>
                    }
                    else
                    {
<span class="fc bfc" id="L306" title="All 3 branches covered.">                        switch (lexer.getCurrent().getType())</span>
                        {
                            case ForwardSlash:
                                do
                                {
<span class="fc" id="L311">                                    commentText.append(lexer.takeCurrent().toString());</span>
                                }
<span class="pc bpc" id="L313" title="1 of 4 branches missed.">                                while (lexer.hasCurrent() &amp;&amp; !lexer.getCurrent().isNewLine());</span>
<span class="fc" id="L314">                                current = JSONToken.lineComment(commentText.toString(), tokenStartIndex);</span>
<span class="fc" id="L315">                                break;</span>

                            case Asterisk:
<span class="fc" id="L318">                                commentText.append(lexer.takeCurrent().toString());</span>
<span class="fc" id="L319">                                boolean previousCharacterWasAsterisk = false;</span>
<span class="fc" id="L320">                                boolean commentClosed = false;</span>
<span class="pc bpc" id="L321" title="1 of 4 branches missed.">                                while (lexer.hasCurrent() &amp;&amp; !commentClosed)</span>
                                {
<span class="fc bfc" id="L323" title="All 3 branches covered.">                                    switch (lexer.getCurrent().getType())</span>
                                    {
                                        case Asterisk:
<span class="fc" id="L326">                                            previousCharacterWasAsterisk = true;</span>
<span class="fc" id="L327">                                            break;</span>

                                        case ForwardSlash:
<span class="fc" id="L330">                                            commentClosed = previousCharacterWasAsterisk;</span>
<span class="fc" id="L331">                                            break;</span>

                                        default:
<span class="fc" id="L334">                                            previousCharacterWasAsterisk = false;</span>
                                            break;
                                    }
<span class="fc" id="L337">                                    commentText.append(lexer.takeCurrent().toString());</span>
                                }
<span class="fc" id="L339">                                current = JSONToken.blockComment(commentText.toString(), tokenStartIndex, commentClosed);</span>
<span class="fc" id="L340">                                break;</span>

                            default:
<span class="fc" id="L343">                                addIssue(JSONIssues.expectedCommentSlashOrAsterisk(lexer.getCurrent().getStartIndex(), lexer.getCurrent().getLength()));</span>
<span class="fc" id="L344">                                current = JSONToken.unrecognized(commentText.toString(), tokenStartIndex);</span>
<span class="fc" id="L345">                                break;</span>
                        }
                    }

                    break;

                default:
<span class="fc" id="L352">                    current = JSONToken.unrecognized(lexer.takeCurrent().toString(), tokenStartIndex);</span>
                    break;
            }
<span class="fc" id="L355">        }</span>
        else
        {
<span class="fc" id="L358">            current = null;</span>
        }

<span class="fc" id="L361">        return hasCurrent();</span>
    }

    private static Action1&lt;Issue&gt; getAddToListAction(final List&lt;Issue&gt; issues)
    {
<span class="fc bfc" id="L366" title="All 2 branches covered.">        return issues == null ? null : issues::add;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>