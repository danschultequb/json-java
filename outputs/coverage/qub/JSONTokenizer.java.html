<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JSONTokenizer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">qub</a> &gt; <span class="el_source">JSONTokenizer.java</span></div><h1>JSONTokenizer.java</h1><pre class="source lang-java linenums">package qub;

/**
 * An object that converts a stream of characters into a stream of JSONTokens.
 */
public class JSONTokenizer implements Iterator&lt;JSONToken&gt;
{
<span class="fc" id="L8">    private static final Iterable&lt;JSONToken&gt; literalTokens = Iterable.create(JSONToken.nullToken, JSONToken.falseToken, JSONToken.trueToken);</span>
    private final Iterator&lt;Character&gt; characters;
    private final CharacterList builder;
    private boolean hasStarted;
    private JSONToken current;

    /**
     * Create a new JSONTokenizer from the provided characters.
     * @param characters The characters to convert to JSONTokens.
     */
    private JSONTokenizer(Iterator&lt;Character&gt; characters)
<span class="fc" id="L19">    {</span>
<span class="fc" id="L20">        PreCondition.assertNotNull(characters, &quot;characters&quot;);</span>

<span class="fc" id="L22">        this.characters = characters;</span>
<span class="fc" id="L23">        this.builder = CharacterList.create();</span>
<span class="fc" id="L24">    }</span>

    /**
     * Create a new JSONTokenizer from the provided text.
     * @param text The text to convert to JSONTokens.
     * @return The new JSONTokenizer.
     */
    public static JSONTokenizer create(String text)
    {
<span class="fc" id="L33">        PreCondition.assertNotNull(text, &quot;text&quot;);</span>

<span class="fc" id="L35">        return JSONTokenizer.create(Strings.iterable(text));</span>
    }

    /**
     * Create a new JSONTokenizer from the provided characters.
     * @param characters The characters to convert to JSONTokens.
     * @return The new JSONTokenizer.
     */
    public static JSONTokenizer create(Iterable&lt;Character&gt; characters)
    {
<span class="fc" id="L45">        PreCondition.assertNotNull(characters, &quot;characters&quot;);</span>

<span class="fc" id="L47">        return JSONTokenizer.create(characters.iterate());</span>
    }

    /**
     * Create a new JSONTokenizer from the provided characters.
     * @param characters The characters to convert to JSONTokens.
     * @return The new JSONTokenizer.
     */
    public static JSONTokenizer create(Iterator&lt;Character&gt; characters)
    {
<span class="fc" id="L57">        PreCondition.assertNotNull(characters, &quot;characters&quot;);</span>

<span class="fc" id="L59">        return new JSONTokenizer(characters);</span>
    }

    @Override
    public boolean hasStarted()
    {
<span class="fc" id="L65">        return this.hasStarted;</span>
    }

    @Override
    public boolean hasCurrent()
    {
<span class="fc bfc" id="L71" title="All 2 branches covered.">        return this.current != null;</span>
    }

    @Override
    public JSONToken getCurrent()
    {
<span class="fc" id="L77">        PreCondition.assertTrue(this.hasCurrent(), &quot;this.hasCurrent()&quot;);</span>

<span class="fc" id="L79">        return this.current;</span>
    }

    @Override
    public boolean next()
    {
<span class="fc" id="L85">        this.characters.ensureHasStarted();</span>
<span class="fc" id="L86">        this.hasStarted = true;</span>

<span class="fc bfc" id="L88" title="All 2 branches covered.">        if (!this.characters.hasCurrent())</span>
        {
<span class="fc" id="L90">            this.current = null;</span>
        }
        else
        {
<span class="fc bfc" id="L94" title="All 12 branches covered.">            switch (this.characters.getCurrent())</span>
            {
                case '{':
<span class="fc" id="L97">                    this.current = JSONToken.leftCurlyBracket;</span>
<span class="fc" id="L98">                    this.characters.next();</span>
<span class="fc" id="L99">                    break;</span>

                case '}':
<span class="fc" id="L102">                    this.current = JSONToken.rightCurlyBracket;</span>
<span class="fc" id="L103">                    this.characters.next();</span>
<span class="fc" id="L104">                    break;</span>

                case '[':
<span class="fc" id="L107">                    this.current = JSONToken.leftSquareBracket;</span>
<span class="fc" id="L108">                    this.characters.next();</span>
<span class="fc" id="L109">                    break;</span>

                case ']':
<span class="fc" id="L112">                    this.current = JSONToken.rightSquareBracket;</span>
<span class="fc" id="L113">                    this.characters.next();</span>
<span class="fc" id="L114">                    break;</span>

                case ':':
<span class="fc" id="L117">                    this.current = JSONToken.colon;</span>
<span class="fc" id="L118">                    this.characters.next();</span>
<span class="fc" id="L119">                    break;</span>

                case ',':
<span class="fc" id="L122">                    this.current = JSONToken.comma;</span>
<span class="fc" id="L123">                    this.characters.next();</span>
<span class="fc" id="L124">                    break;</span>

                case '\n':
<span class="fc" id="L127">                    this.current = JSONToken.newLine;</span>
<span class="fc" id="L128">                    this.characters.next();</span>
<span class="fc" id="L129">                    break;</span>

                case '\r':
<span class="fc bfc" id="L132" title="All 4 branches covered.">                    if (this.characters.next() &amp;&amp; this.characters.getCurrent() == '\n')</span>
                    {
<span class="fc" id="L134">                        this.current = JSONToken.carriageReturnNewLine;</span>
<span class="fc" id="L135">                        this.characters.next();</span>
                    }
                    else
                    {
<span class="fc" id="L139">                        this.current = JSONToken.carriageReturn;</span>
                    }
<span class="fc" id="L141">                    break;</span>

                case '\'':
                case '\&quot;':
<span class="fc" id="L145">                    this.current = JSONToken.quotedString(this.readQuotedString());</span>
<span class="fc" id="L146">                    break;</span>

                case ' ':
                case '\t':
<span class="fc" id="L150">                    this.current = JSONToken.whitespace(this.readWhitespace());</span>
<span class="fc" id="L151">                    break;</span>

                case '/':
<span class="fc" id="L154">                    this.current = this.readCommentToken();</span>
<span class="fc" id="L155">                    break;</span>

                default:
<span class="fc bfc" id="L158" title="All 2 branches covered.">                    if (JSONTokenizer.isLetter(this.characters.getCurrent()))</span>
                    {
<span class="fc" id="L160">                        final String tokenText = this.readLiteral();</span>
<span class="fc" id="L161">                        this.current = JSONTokenizer.literalTokens.first((JSONToken token) -&gt; token.getText().equals(tokenText));</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">                        if (this.current == null)</span>
                        {
<span class="fc" id="L164">                            throw new ParseException(&quot;Unrecognized JSONToken literal: &quot; + tokenText);</span>
                        }
<span class="fc" id="L166">                    }</span>
<span class="fc bfc" id="L167" title="All 4 branches covered.">                    else if (this.characters.getCurrent() == '-' || JSONTokenizer.isDigit(this.characters.getCurrent()))</span>
                    {
<span class="fc" id="L169">                        final String tokenText = this.readNumber();</span>
<span class="fc" id="L170">                        this.current = JSONToken.number(tokenText);</span>
<span class="fc" id="L171">                    }</span>
                    else
                    {
<span class="fc" id="L174">                        throw new ParseException(&quot;Unrecognized JSONToken start character: &quot; + Strings.escapeAndQuote(this.characters.getCurrent()));</span>
                    }
            }
        }

<span class="fc" id="L179">        return this.hasCurrent();</span>
    }

    /**
     * Get whether or not the provided character is a recognized JSON letter.
     * @param character The character to check.
     * @return Whether or not the provided character is a recognized JSON letter.
     */
    public static boolean isLetter(char character)
    {
<span class="fc bfc" id="L189" title="All 8 branches covered.">        return ('a' &lt;= character &amp;&amp; character &lt;= 'z') ||</span>
            ('A' &lt;= character &amp;&amp; character &lt;= 'Z');
    }

    /**
     * Get whether or not the provided character is a recognized JSON digit.
     * @param character The character to check.
     * @return Whether or not the provided character is a recognized JSON digit.
     */
    public static boolean isDigit(char character)
    {
<span class="fc bfc" id="L200" title="All 4 branches covered.">        return '0' &lt;= character &amp;&amp; character &lt;= '9';</span>
    }

    /**
     * Get whether or not the provided character is a recognized JSON whitespace character.
     * @param character The character to check.
     * @return Whether or not the provided character is a recognized JSON whitespace character.
     */
    public static boolean isWhitespace(char character)
    {
<span class="fc bfc" id="L210" title="All 4 branches covered.">        return ' ' == character || '\t' == character;</span>
    }

    private String readLiteral()
    {
<span class="fc" id="L215">        PreCondition.assertTrue(this.characters.hasCurrent(), &quot;characters.hasCurrent()&quot;);</span>
<span class="fc" id="L216">        PreCondition.assertTrue(JSONTokenizer.isLetter(this.characters.getCurrent()), &quot;JSONTokenizer.isLetter(this.characters.getCurrent())&quot;);</span>

<span class="fc" id="L218">        this.builder.add(this.characters.takeCurrent());</span>
<span class="fc bfc" id="L219" title="All 4 branches covered.">        while (this.characters.hasCurrent() &amp;&amp; JSONTokenizer.isLetter(this.characters.getCurrent()))</span>
        {
<span class="fc" id="L221">            this.builder.add(this.characters.takeCurrent());</span>
        }

<span class="fc" id="L224">        final String result = this.builder.toString(true);</span>
<span class="fc" id="L225">        this.builder.clear();</span>

<span class="fc" id="L227">        PostCondition.assertNotNullAndNotEmpty(result, &quot;result&quot;);</span>

<span class="fc" id="L229">        return result;</span>
    }

    private String readQuotedString()
    {
<span class="fc" id="L234">        PreCondition.assertTrue(this.characters.hasCurrent(), &quot;this.characters.hasCurrent()&quot;);</span>
<span class="fc" id="L235">        PreCondition.assertOneOf(this.characters.getCurrent(), Iterable.create('\'', '\&quot;'), &quot;this.characters.getCurrent()&quot;);</span>

<span class="fc" id="L237">        final char startQuote = this.characters.takeCurrent();</span>
<span class="fc" id="L238">        this.builder.add(startQuote);</span>
<span class="fc" id="L239">        boolean escaped = false;</span>
<span class="fc" id="L240">        boolean foundCloseQuote = false;</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">        while (this.characters.hasCurrent())</span>
        {
<span class="fc" id="L243">            final char currentCharacter = this.characters.takeCurrent();</span>
<span class="fc" id="L244">            this.builder.add(currentCharacter);</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">            if (escaped)</span>
            {
<span class="fc" id="L247">                escaped = false;</span>
            }
<span class="fc bfc" id="L249" title="All 2 branches covered.">            else if (currentCharacter == '\\')</span>
            {
<span class="fc" id="L251">                escaped = true;</span>
            }
<span class="fc bfc" id="L253" title="All 2 branches covered.">            else if (currentCharacter == startQuote)</span>
            {
<span class="fc" id="L255">                foundCloseQuote = true;</span>
<span class="fc" id="L256">                break;</span>
            }
<span class="fc" id="L258">        }</span>

<span class="fc bfc" id="L260" title="All 2 branches covered.">        if (!foundCloseQuote)</span>
        {
<span class="fc" id="L262">            throw new ParseException(&quot;Missing quoted-string closing quote: &quot; + startQuote);</span>
        }

<span class="fc" id="L265">        final String result = this.builder.toString(true);</span>
<span class="fc" id="L266">        this.builder.clear();</span>

<span class="fc" id="L268">        PostCondition.assertNotNullAndNotEmpty(result, &quot;result&quot;);</span>

<span class="fc" id="L270">        return result;</span>
    }

    private String readNumber()
    {
<span class="fc" id="L275">        PreCondition.assertTrue(this.characters.hasCurrent(), &quot;this.characters.hasCurrent()&quot;);</span>
<span class="fc" id="L276">        PreCondition.assertOneOf(this.characters.getCurrent(), Iterable.create('-', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9'), &quot;this.characters.getCurrent()&quot;);</span>

<span class="fc bfc" id="L278" title="All 2 branches covered.">        if (this.characters.getCurrent() == '-')</span>
        {
<span class="fc" id="L280">            this.builder.add(this.characters.takeCurrent());</span>

<span class="fc bfc" id="L282" title="All 4 branches covered.">            if (!this.characters.hasCurrent() || !JSONTokenizer.isDigit(this.characters.getCurrent()))</span>
            {
<span class="fc" id="L284">                throw new ParseException(&quot;Missing digits after number's negative sign: \&quot;-\&quot;&quot;);</span>
            }
        }

<span class="fc bfc" id="L288" title="All 4 branches covered.">        while (this.characters.hasCurrent() &amp;&amp; JSONTokenizer.isDigit(this.characters.getCurrent()))</span>
        {
<span class="fc" id="L290">            this.builder.add(this.characters.takeCurrent());</span>
        }

<span class="fc bfc" id="L293" title="All 4 branches covered.">        if (this.characters.hasCurrent() &amp;&amp; this.characters.getCurrent() == '.')</span>
        {
<span class="fc" id="L295">            this.builder.add(this.characters.takeCurrent());</span>
<span class="fc bfc" id="L296" title="All 4 branches covered.">            if (!this.characters.hasCurrent() || !JSONTokenizer.isDigit(this.characters.getCurrent()))</span>
            {
<span class="fc" id="L298">                throw new ParseException(&quot;Missing digits after number's decimal point: &quot; + Strings.escapeAndQuote(this.builder.toString(true)));</span>
            }

            do
            {
<span class="fc" id="L303">                this.builder.add(this.characters.takeCurrent());</span>
            }
<span class="fc bfc" id="L305" title="All 4 branches covered.">            while (this.characters.hasCurrent() &amp;&amp; JSONTokenizer.isDigit(this.characters.getCurrent()));</span>
        }

<span class="fc bfc" id="L308" title="All 6 branches covered.">        if (this.characters.hasCurrent() &amp;&amp; (this.characters.getCurrent().equals('e') || this.characters.getCurrent().equals('E')))</span>
        {
<span class="fc" id="L310">            this.builder.add(this.characters.takeCurrent());</span>

<span class="fc bfc" id="L312" title="All 8 branches covered.">            if (!this.characters.hasCurrent() || !(this.characters.getCurrent().equals('-') || this.characters.getCurrent().equals('+') || JSONTokenizer.isDigit(this.characters.getCurrent())))</span>
            {
<span class="fc" id="L314">                throw new ParseException(&quot;Missing digits after number's exponent character: &quot; + Strings.escapeAndQuote(this.builder.toString(true)));</span>
            }
            else
            {
<span class="fc" id="L318">                this.builder.add(this.characters.takeCurrent());</span>
<span class="fc bfc" id="L319" title="All 4 branches covered.">                if ((this.builder.endsWith('-') || this.builder.endsWith('+')) &amp;&amp;</span>
<span class="fc bfc" id="L320" title="All 4 branches covered.">                    (!this.characters.hasCurrent() || !JSONTokenizer.isDigit(this.characters.getCurrent())))</span>
                {
<span class="fc" id="L322">                    throw new ParseException(&quot;Missing digits after number's exponent sign character: &quot; + Strings.escapeAndQuote(this.builder.toString(true)));</span>
                }

<span class="fc bfc" id="L325" title="All 4 branches covered.">                while (this.characters.hasCurrent() &amp;&amp; JSONTokenizer.isDigit(this.characters.getCurrent()))</span>
                {
<span class="fc" id="L327">                    this.builder.add(this.characters.takeCurrent());</span>
                }
            }
        }

<span class="fc" id="L332">        final String result = builder.toString(true);</span>
<span class="fc" id="L333">        builder.clear();</span>

<span class="fc" id="L335">        PostCondition.assertNotNullAndNotEmpty(result, &quot;result&quot;);</span>

<span class="fc" id="L337">        return result;</span>
    }

    private String readWhitespace()
    {
<span class="fc" id="L342">        PreCondition.assertTrue(this.characters.hasCurrent(), &quot;this.characters.hasCurrent()&quot;);</span>
<span class="fc" id="L343">        PreCondition.assertTrue(JSONTokenizer.isWhitespace(this.characters.getCurrent()), &quot;JSONTokenizer.isWhitespace(this.characters.getCurrent())&quot;);</span>

        do
        {
<span class="fc" id="L347">            builder.add(this.characters.takeCurrent());</span>
        }
<span class="fc bfc" id="L349" title="All 4 branches covered.">        while (this.characters.hasCurrent() &amp;&amp; JSONTokenizer.isWhitespace(this.characters.getCurrent()));</span>

<span class="fc" id="L351">        final String result = builder.toString(true);</span>
<span class="fc" id="L352">        builder.clear();</span>

<span class="fc" id="L354">        PostCondition.assertNotNullAndNotEmpty(result, &quot;result&quot;);</span>

<span class="fc" id="L356">        return result;</span>
    }

    private JSONToken readCommentToken()
    {
<span class="fc" id="L361">        PreCondition.assertTrue(this.characters.hasCurrent(), &quot;this.characters.hasCurrent()&quot;);</span>
<span class="fc" id="L362">        PreCondition.assertEqual('/', this.characters.getCurrent(), &quot;this.characters.getCurrent()&quot;);</span>

<span class="fc bfc" id="L364" title="All 2 branches covered.">        if (!this.characters.next())</span>
        {
<span class="fc" id="L366">            throw new ParseException(&quot;Missing comment start sequence second character.&quot;);</span>
        }

        JSONTokenType resultType;
<span class="fc" id="L370">        this.builder.add('/');</span>
<span class="fc bfc" id="L371" title="All 2 branches covered.">        if (this.characters.getCurrent() == '/')</span>
        {
<span class="fc" id="L373">            resultType = JSONTokenType.LineComment;</span>
<span class="fc" id="L374">            this.builder.add(this.characters.takeCurrent());</span>
<span class="fc bfc" id="L375" title="All 6 branches covered.">            while (this.characters.hasCurrent() &amp;&amp; this.characters.getCurrent() != '\r' &amp;&amp; this.characters.getCurrent() != '\n')</span>
            {
<span class="fc" id="L377">                this.builder.add(this.characters.takeCurrent());</span>
            }
        }
<span class="fc bfc" id="L380" title="All 2 branches covered.">        else if (this.characters.getCurrent() == '*')</span>
        {
<span class="fc" id="L382">            resultType = JSONTokenType.BlockComment;</span>
<span class="fc" id="L383">            this.builder.add(this.characters.takeCurrent());</span>
<span class="fc" id="L384">            boolean endSequenceStarted = false;</span>
<span class="fc" id="L385">            boolean ended = false;</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">            while (this.characters.hasCurrent())</span>
            {
<span class="fc" id="L388">                final char character = this.characters.takeCurrent();</span>
<span class="fc" id="L389">                this.builder.add(character);</span>
<span class="fc bfc" id="L390" title="All 4 branches covered.">                if (endSequenceStarted &amp;&amp; character == '/')</span>
                {
<span class="fc" id="L392">                    ended = true;</span>
<span class="fc" id="L393">                    break;</span>
                }
<span class="fc bfc" id="L395" title="All 2 branches covered.">                endSequenceStarted = (character == '*');</span>
<span class="fc" id="L396">            }</span>

<span class="fc bfc" id="L398" title="All 2 branches covered.">            if (!ended)</span>
            {
<span class="fc bfc" id="L400" title="All 2 branches covered.">                throw new ParseException(endSequenceStarted</span>
<span class="fc" id="L401">                    ? &quot;Missing block comment end sequence second character (\&quot;/\&quot;).&quot;</span>
<span class="fc" id="L402">                    : &quot;Missing block comment end sequence (\&quot;*/\&quot;).&quot;);</span>
            }
<span class="fc" id="L404">        }</span>
        else
        {
<span class="fc" id="L407">            throw new ParseException(&quot;Unrecognized comment start sequence second character: &quot; + Strings.escapeAndQuote(this.characters.getCurrent()));</span>
        }

<span class="fc" id="L410">        final String resultText = this.builder.toString(true);</span>
<span class="fc" id="L411">        this.builder.clear();</span>

<span class="fc" id="L413">        final JSONToken result = new JSONToken(resultText, resultType);</span>

<span class="fc" id="L415">        PostCondition.assertNotNull(result, &quot;result&quot;);</span>

<span class="fc" id="L417">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>